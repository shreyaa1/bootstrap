#!/usr/bin/env node
const http =require('http');
const path = require('path');
const fs = require('fs');
const mime = require('mime');
const server = http.createServer(function (req,res) {
    if(req.url=='/favicon.ico'){
        res.end();
        return;
    }
    var staticPath = process.cwd();
    if(fs.existsSync(path.join(staticPath,'/index.html'))){
        res.setHeader('Content-type',mime.lookup(req.url))
        fs.createReadStream(path.join(staticPath,'/index.html')).pipe(res);
    }else{
        var pathName = path.join(staticPath,decodeURI(req.url));
        if(fs.statSync(pathName).isDirectory()){
            var dirs = fs.readdirSync(pathName);
            console.log(dirs);
            var str ="";
            dirs.forEach(function (item,index) {
                var stat = fs.statSync(path.join(pathName,item));
                if(stat.isDirectory()){
                    str+=`<tr><td>${index}</td><td></td><td><a href="${req.url}${item}/">${item}</a></td></tr>`;
                }else{
                    str+=`<tr><td>${index}</td><td>${Math.ceil(stat.size/1024)}kb</td><td><a href="${req.url}${item}">${item}</a></td></tr>`;
                }
            })
            res.setHeader('Content-type','text/html');
            res.write(`<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>Httpserver</title><style>body{margin:0;}h3{margin:0;padding:0;line-height:50px;background:#666;color:#fff;}table{margin:30px 50px;border-left:1px solid #ddd;border-top:1px solid #ddd;border-spacing: 0;}td{border-bottom:1px solid #ddd;border-right:1px solid #ddd;padding:15px 30px;}</style></head><body><h3>Index of/</h3><table>${str}</table></body></html>`);
            res.end();
        }else{
            if(fs.existsSync(pathName)){
                fs.createReadStream(pathName).pipe(res);
            }else{
                res.statusCode=404;
                res.end();
            }
        }
    }

})
server.listen(8888,function () {
    console.log("server running is :http://localhost:"+server.address().port)
})



